{% extends "base.html" %}

{% block page_title %}Adicionar Boleto{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 0 auto;">
    <div class="card-header">
        <h3 style="margin: 0;">Novo Boleto</h3>
    </div>
    
    <form method="POST" enctype="multipart/form-data" style="padding: 2rem;" id="boletoForm">
        {% if erro %}
        <div style="background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border-left: 4px solid #dc3545;">
            <strong>‚ùå Erro:</strong> {{ erro }}
        </div>
        {% endif %}

        <div style="margin-bottom: 1.5rem; padding: 1.5rem; background-color: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
            <label for="imagem_boleto" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                üì∑ Escanear Boleto com OCR (Opcional)
            </label>
            <input type="file" id="imagem_boleto" name="imagem_boleto" accept="image/*" style="margin-bottom: 0.5rem;">
            <button type="button" id="btnProcessarOCR" class="btn btn-outline" style="width: 100%; margin-top: 0.5rem;">
                üîç Processar Imagem com OCR
            </button>
            <div id="ocrStatus" style="margin-top: 0.5rem; display: none;"></div>
            <div id="previewImagem" style="margin-top: 1rem; display: none;">
                <img id="imagemPreview" src="" alt="Preview" style="max-width: 100%; border-radius: 4px;">
            </div>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="codigo" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">C√≥digo de Barras*</label>
            <input type="text" id="codigo" name="codigo" class="form-control" placeholder="Ex: 12345.67890 12345.678901..." required>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="vencimento" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Vencimento*</label>
            <input type="date" id="vencimento" name="vencimento" class="form-control" required>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="valor" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Valor (R$)*</label>
            <input type="number" id="valor" name="valor" class="form-control" placeholder="0.00" step="0.01" min="0" required>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="status" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Status*</label>
            <select id="status" name="status" class="form-control" required>
                <option value="A vencer">A vencer</option>
                <option value="Vencido">Vencido</option>
                <option value="Pago">Pago</option>
            </select>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="tipo" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Tipo</label>
            <input type="text" id="tipo" name="tipo" class="form-control" placeholder="Ex: Pagamento, Entrada...">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="descricao" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Descri√ß√£o</label>
            <textarea id="descricao" name="descricao" class="form-control" placeholder="Digite uma descri√ß√£o..." rows="4"></textarea>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label for="fornecedor_id" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Fornecedor</label>
            <select id="fornecedor_id" name="fornecedor_id" class="form-control">
                <option value="">Selecione um fornecedor (opcional)</option>
                {% for fornecedor in fornecedores %}
                <option value="{{ fornecedor.id }}">{{ fornecedor.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar Boleto</button>
            <a href="{{ url_for('finance.boletos') }}" class="btn btn-outline" style="flex: 1; text-align: center; text-decoration: none;">Cancelar</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imagemInput = document.getElementById('imagem_boleto');
    const btnProcessarOCR = document.getElementById('btnProcessarOCR');
    const ocrStatus = document.getElementById('ocrStatus');
    const previewImagem = document.getElementById('previewImagem');
    const imagemPreview = document.getElementById('imagemPreview');
    
    // Preview da imagem
    imagemInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagemPreview.src = e.target.result;
                previewImagem.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Processar OCR
    btnProcessarOCR.addEventListener('click', function() {
        const file = imagemInput.files[0];
        if (!file) {
            ocrStatus.innerHTML = '<div style="color: #dc3545; padding: 0.5rem;">‚ö†Ô∏è Por favor, selecione uma imagem primeiro.</div>';
            ocrStatus.style.display = 'block';
            return;
        }
        
        const formData = new FormData();
        formData.append('imagem', file);
        
        ocrStatus.innerHTML = '<div style="color: #0d6efd; padding: 0.5rem;">‚è≥ Processando imagem com OCR...</div>';
        ocrStatus.style.display = 'block';
        btnProcessarOCR.disabled = true;
        
        fetch('{{ url_for("finance.processar_ocr_boleto") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            btnProcessarOCR.disabled = false;
            if (data.sucesso && data.dados) {
                // Preencher campos com dados extra√≠dos
                if (data.dados.codigo) {
                    document.getElementById('codigo').value = data.dados.codigo;
                }
                if (data.dados.vencimento) {
                    document.getElementById('vencimento').value = data.dados.vencimento;
                }
                if (data.dados.valor) {
                    document.getElementById('valor').value = data.dados.valor;
                }
                if (data.dados.descricao) {
                    document.getElementById('descricao').value = data.dados.descricao;
                }
                
                ocrStatus.innerHTML = '<div style="color: #198754; padding: 0.5rem;">‚úÖ OCR processado com sucesso! Campos preenchidos automaticamente.</div>';
            } else {
                ocrStatus.innerHTML = '<div style="color: #ffc107; padding: 0.5rem;">‚ö†Ô∏è OCR processado, mas alguns campos podem n√£o ter sido encontrados. Verifique os dados extra√≠dos.</div>';
            }
        })
        .catch(error => {
            btnProcessarOCR.disabled = false;
            ocrStatus.innerHTML = '<div style="color: #dc3545; padding: 0.5rem;">‚ùå Erro ao processar OCR: ' + error.message + '</div>';
        });
    });
});
</script>
{% endblock %}
